schema: '2.0'
stages:
  sync_negative_train_samples:
    cmd: aws s3 cp s3://ezra-ml-dvc/reporter/df_negative_for_train_and_stats.csv ./data/df_negative_for_train_and_stats.csv
    deps:
    - path: s3://ezra-ml-dvc/reporter/df_negative_for_train_and_stats.csv
      etag: f6b1f978f37012919aaefc68fe6e07e7
      size: 1592506
    outs:
    - path: data/df_negative_for_train_and_stats.csv
      md5: f6b1f978f37012919aaefc68fe6e07e7
      size: 1592506
  sync_positive_train_samples:
    cmd: aws s3 cp s3://ezra-ml-dvc/reporter/df_positive_w_id_for_train_and_stats.csv
      ./data/df_positive_w_id_for_train_and_stats.csv
    deps:
    - path: s3://ezra-ml-dvc/reporter/df_positive_w_id_for_train_and_stats.csv
      etag: 60d30f28dbc13dd65f763d97f7d0a802
      size: 3761166
    outs:
    - path: data/df_positive_w_id_for_train_and_stats.csv
      md5: cb351a0d8e69b4cb263e6265bb5bfff2
      size: 3761166
  sync_snippet_database:
    cmd: aws s3 cp s3://ezra-ml-dvc/reporter/cleaned_snippets_with_org_name_new_rows.csv
      ./data/cleaned_snippets_with_org_name_new_rows.csv
    deps:
    - path: s3://ezra-ml-dvc/reporter/cleaned_snippets_with_org_name_new_rows.csv
      etag: 945af0c2c6c3518377534b8740b0a0a5
      size: 799345
    outs:
    - path: data/cleaned_snippets_with_org_name_new_rows.csv
      md5: 5376aeada62a4fb140929455ffe52e76
      size: 799345
  sync_uml_sbert:
    cmd: docker-compose run ml.thageesan "python -m ai.migration.download_umlsbert
      ."
    deps:
    - path: ai/migration/download_umlsbert/__init__.py
      md5: 96b955ac064dea78e099e40bdb58baf1
      size: 1297
    - path: ai/migration/download_umlsbert/__main__.py
      md5: 28c8ccf23d63e0a8262fb7347708d3c8
      size: 85
    params:
      params.py:
        UMLS_MODEL_NAME: GanjinZero/UMLSBert_ENG
    outs:
    - path: data/UMLS/config.json
      md5: 1548c9643eaee9881e522896ebc96396
      size: 605
    - path: data/UMLS/pytorch_model.bin
      md5: e51a431feca65ed1e7784312cf1af54d
      size: 438007537
    - path: data/UMLS/vocab.txt
      md5: 7f5029172a4e3c1198f13c92bdb06d89
      size: 225062
  embed_umlsbert_snippets:
    cmd: docker-compose run ml.thageesan "python -m ai.data_pipeline.embed_snippets_umlsbert
      ."
    deps:
    - path: ai/data_pipeline/embed_snippets_umlsbert/__init__.py
      md5: b1d00420369b4cf9dd76324501679f1e
      size: 2415
    - path: ai/data_pipeline/embed_snippets_umlsbert/__main__.py
      md5: d0d8170aef7d5d0e5662af9ca9cd4eb0
      size: 254
    - path: data/UMLS/config.json
      md5: 1548c9643eaee9881e522896ebc96396
      size: 605
    - path: data/UMLS/pytorch_model.bin
      md5: e51a431feca65ed1e7784312cf1af54d
      size: 438007537
    - path: data/UMLS/vocab.txt
      md5: 7f5029172a4e3c1198f13c92bdb06d89
      size: 225062
    - path: data/training_samples.parquet
      md5: f786a1a0f43a8abdffdca36e2a5e36f5
      size: 148993
    outs:
    - path: data/embed_snippets_umls.parquet
      md5: 5d5411f76f66ba398447384d76cfb7e9
      size: 66006966
  sync_bio_sent:
    cmd: docker-compose run ml.thageesan "python -m ai.migration.sync_bio_sent ."
    deps:
    - path: ai/migration/sync_bio_sent/__init__.py
      md5: 3d7c9a9c7c01712a68813f7dd449a1b3
      size: 716
    - path: ai/migration/sync_bio_sent/__main__.py
      md5: 19bca0b53b7ca16ec99a1b8107f82f60
      size: 81
    params:
      params.py:
        BIOSENT_FILE_NAME: bioSent2Vec.bin
    outs:
    - path: data/bioSent2Vec.bin
      md5: e0c6c5cf7e4f8e88ec253ee46b461e58
      size: 22475736490
  embed_biosent_snippets:
    cmd: docker-compose run ml.thageesan "python -m ai.data_pipeline.embed_snippets_biosent
      ."
    deps:
    - path: ai/data_pipeline/embed_snippets_biosent/__init__.py
      md5: 7d60f668fa422b747053a41b0526c8fe
      size: 2198
    - path: ai/data_pipeline/embed_snippets_biosent/__main__.py
      md5: 94ac76570d1c72169c160c4b73b57c10
      size: 252
    - path: data/bioSent2Vec.bin
      md5: e0c6c5cf7e4f8e88ec253ee46b461e58
      size: 22475736490
    - path: data/training_samples.parquet
      md5: f786a1a0f43a8abdffdca36e2a5e36f5
      size: 148993
    params:
      params.py:
        BIOSENT_FILE_NAME: bioSent2Vec.bin
    outs:
    - path: data/embed_snippets_biosent.parquet
      md5: adf465e4748ca9ca1ee1b0c72f02d74b
      size: 60191575
  generate_training_samples:
    cmd: docker-compose run ml.thageesan "python -m ai.data_pipeline.generate_training_samples
      ."
    deps:
    - path: ai/data_pipeline/generate_training_samples/__init__.py
      md5: e00de7129b42ebd3b657feedc3e8fff4
      size: 3341
    - path: ai/data_pipeline/generate_training_samples/__main__.py
      md5: bddc9ff3357bab4ccf6c0218a8cfc36d
      size: 256
    - path: data/df_negative_for_train_and_stats.csv
      md5: f6b1f978f37012919aaefc68fe6e07e7
      size: 1592506
    - path: data/df_positive_w_id_for_train_and_stats.csv
      md5: cb351a0d8e69b4cb263e6265bb5bfff2
      size: 3761166
    outs:
    - path: data/training_samples.parquet
      md5: f786a1a0f43a8abdffdca36e2a5e36f5
      size: 148993
  generate_corpus:
    cmd: docker-compose run ml.thageesan "python -m ai.data_pipeline.generate_corpus
      ."
    deps:
    - path: ai/data_pipeline/generate_corpus/__init__.py
      md5: c43d25f486aacd8af1b467cba665f1e3
      size: 1116
    - path: ai/data_pipeline/generate_corpus/__main__.py
      md5: e7c69f6ce808a6c40dea70161553c93b
      size: 87
    - path: data/cleaned_snippets_with_org_name_new_rows.csv
      md5: 5376aeada62a4fb140929455ffe52e76
      size: 799345
    outs:
    - path: data/corpus.npy
      md5: e5322ad566d1d16ddf4f36695e072234
      size: 85060
  embed_umlsbert_finding:
    cmd: docker-compose run ml.thageesan "python -m ai.data_pipeline.embed_finding_umlsbert
      ."
    deps:
    - path: ai/data_pipeline/embed_finding_umlsbert/__init__.py
      md5: 0f8977c8e5cbaf5bc993fe6d66888096
      size: 2630
    - path: ai/data_pipeline/embed_finding_umlsbert/__main__.py
      md5: 697fce12999071cf5c64234c3ff6a0c9
      size: 253
    - path: data/UMLS/config.json
      md5: 1548c9643eaee9881e522896ebc96396
      size: 605
    - path: data/UMLS/pytorch_model.bin
      md5: e51a431feca65ed1e7784312cf1af54d
      size: 438007537
    - path: data/UMLS/vocab.txt
      md5: 7f5029172a4e3c1198f13c92bdb06d89
      size: 225062
    - path: data/training_samples.parquet
      md5: f786a1a0f43a8abdffdca36e2a5e36f5
      size: 148993
    outs:
    - path: data/embed_finding_umls.parquet
      md5: c5bc759fe9815d1974af6ffd7683a11b
      size: 87831425
  embed_biosent_finding:
    cmd: docker-compose run ml.thageesan "python -m ai.data_pipeline.embed_finding_biosent
      ."
    deps:
    - path: ai/data_pipeline/embed_finding_biosent/__init__.py
      md5: a5a136f8b34362119588713b67edd0d2
      size: 2190
    - path: ai/data_pipeline/embed_finding_biosent/__main__.py
      md5: e7a0a2e61bad8a4d0a95b6aa933450fd
      size: 252
    - path: data/bioSent2Vec.bin
      md5: e0c6c5cf7e4f8e88ec253ee46b461e58
      size: 22475736490
    - path: data/training_samples.parquet
      md5: f786a1a0f43a8abdffdca36e2a5e36f5
      size: 148993
    params:
      params.py:
        BIOSENT_FILE_NAME: bioSent2Vec.bin
    outs:
    - path: data/embed_finding_biosent.parquet
      md5: b84ef1b0ce89266e77b0072df3c88aff
      size: 80526054
  embed_number_in_finding:
    cmd: docker-compose run ml.thageesan "python -m ai.data_pipeline.embed_numbers_umls
      ."
    deps:
    - path: ai/data_pipeline/embed_numbers_umls/__init__.py
      md5: 63222a8f8b1efcd9f897306758d43e07
      size: 1807
    - path: ai/data_pipeline/embed_numbers_umls/__main__.py
      md5: 7b27e85644eb3c496cfa3d1c8aa79bfd
      size: 249
    - path: data/UMLS/config.json
      md5: 1548c9643eaee9881e522896ebc96396
      size: 605
    - path: data/UMLS/pytorch_model.bin
      md5: e51a431feca65ed1e7784312cf1af54d
      size: 438007537
    - path: data/UMLS/vocab.txt
      md5: 7f5029172a4e3c1198f13c92bdb06d89
      size: 225062
    - path: data/training_samples.parquet
      md5: f786a1a0f43a8abdffdca36e2a5e36f5
      size: 148993
    outs:
    - path: data/embed_numbers_umls.parquet
      md5: a2737097877e123f484299beb7ec2fa5
      size: 1796642
  extract_features_for_training:
    cmd: docker-compose run ml.thageesan "python -m ai.data_pipeline.feature_extraction.training
      ."
    deps:
    - path: ai/data_pipeline/feature_extraction/training/__init__.py
      md5: 0c2ffdec99eadf67b94d0ac4b958adce
      size: 5466
    - path: ai/data_pipeline/feature_extraction/training/__main__.py
      md5: dcc9cac4893d68c135b49723816bd195
      size: 258
    - path: data/corpus.npy
      md5: e5322ad566d1d16ddf4f36695e072234
      size: 85060
    - path: data/embed_finding_biosent.parquet
      md5: b84ef1b0ce89266e77b0072df3c88aff
      size: 80526054
    - path: data/embed_finding_umls.parquet
      md5: c5bc759fe9815d1974af6ffd7683a11b
      size: 87831425
    - path: data/embed_numbers_umls.parquet
      md5: 7e761d64d2fbcb369edddf0033acd27c
      size: 1796642
    - path: data/embed_snippets_biosent.parquet
      md5: adf465e4748ca9ca1ee1b0c72f02d74b
      size: 60191575
    - path: data/embed_snippets_umls.parquet
      md5: 5d5411f76f66ba398447384d76cfb7e9
      size: 66006966
    - path: data/training_samples.parquet
      md5: f786a1a0f43a8abdffdca36e2a5e36f5
      size: 148993
    outs:
    - path: data/feature_extraction_training.parquet
      md5: e9c4e6c553ce6f181cae609c8a514b6e
      size: 170014
  extract_features:
    cmd: docker-compose run ml.thageesan "python -m ai.data_pipeline.feature_extraction
      ."
    deps:
    - path: ai/data_pipeline/feature_extraction/__init__.py
      md5: 92a87825284c8828dec1583f162d0592
      size: 5457
    - path: ai/data_pipeline/feature_extraction/__main__.py
      md5: ec5289084b09a6a810e602883cd438ec
      size: 249
    - path: data/corpus.npy
      md5: e5322ad566d1d16ddf4f36695e072234
      size: 85060
    - path: data/embed_finding_biosent.parquet
      md5: b84ef1b0ce89266e77b0072df3c88aff
      size: 80526054
    - path: data/embed_finding_umls.parquet
      md5: c5bc759fe9815d1974af6ffd7683a11b
      size: 87831425
    - path: data/embed_numbers_umls.parquet
      md5: a2737097877e123f484299beb7ec2fa5
      size: 1796642
    - path: data/embed_snippets_biosent.parquet
      md5: adf465e4748ca9ca1ee1b0c72f02d74b
      size: 60191575
    - path: data/embed_snippets_umls.parquet
      md5: 5d5411f76f66ba398447384d76cfb7e9
      size: 66006966
    - path: data/training_samples.parquet
      md5: f786a1a0f43a8abdffdca36e2a5e36f5
      size: 148993
    outs:
    - path: data/feature_extraction.parquet
      md5: 75082ab09491869a41d1b5b2bcee1520
      size: 169998
  train_test_split:
    cmd: docker-compose run ml.thageesan "python -m ai.data_pipeline.train_test_split
      ."
    deps:
    - path: ai/data_pipeline/train_test_split/__init__.py
      md5: 798a8dce7bda09041f46822faaa380af
      size: 701
    - path: ai/data_pipeline/train_test_split/__main__.py
      md5: 6864810be22611cf7b7b88df3f4e7dc5
      size: 247
    - path: data/feature_extraction.parquet
      md5: 75082ab09491869a41d1b5b2bcee1520
      size: 169998
    params:
      params.py:
        TestTrainSetConfig:
          TEST_SIZE: 0.2
    outs:
    - path: data/testing_set.parquet
      md5: 6f9d326436422a685ecf6395401735e9
      size: 53923
    - path: data/training_set.parquet
      md5: 419b8206d27d4ac66771839a411701b2
      size: 182176
  train_model:
    cmd: docker-compose run ml.thageesan "python -m ai.training ."
    deps:
    - path: ai/training/__init__.py
      md5: 27e8ed32da413cf69e40f01b44fbe466
      size: 1296
    - path: ai/training/__main__.py
      md5: 9c780328b11074dd3936ea268a56e93d
      size: 225
    - path: data/training_set.parquet
      md5: 419b8206d27d4ac66771839a411701b2
      size: 182176
    params:
      params.py:
        XGBTrainConfig:
          subsample: 0.8
          n_estimators: 400
          min_child_weight: 5
          max_depth: 6
          learning_rate: 0.1
          gamma: 2
          colsample_bytree: 0.8
          alpha: 5
          eval_metric: auc
          objective: binary:logistic
          use_label_encoder: false
    outs:
    - path: data/xgb.model
      md5: da10ccd873cba5dde63bfd1ab3ebe33c
      size: 1488586
  test_model:
    cmd: docker-compose run ml.thageesan "python -m ai.test ."
    deps:
    - path: ai/test/__init__.py
      md5: 2120f81a93ff4b35680684fab85fe4bf
      size: 1349
    - path: ai/test/__main__.py
      md5: 00955820270b13976fda9fb9179453c7
      size: 221
    - path: data/testing_set.parquet
      md5: 6f9d326436422a685ecf6395401735e9
      size: 53923
    - path: data/xgb.model
      md5: da10ccd873cba5dde63bfd1ab3ebe33c
      size: 1488586
    outs:
    - path: metrics/test_results.json
      md5: 9586674efc1489ba751124c62dfe94f7
      size: 229
